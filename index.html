<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcards — Row Editor (Front | Back) → Arrange & Print</title>
<style>
  :root{
    --page-w: 11in; --page-h: 8.5in;   /* LANDSCAPE Letter sheet */
    --card-w: 5.5in; --card-h: 4.25in; /* Card size */
    --safe: 0.125in; --crop: 0.12in; --margin: 0.25in;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  html,body{background:#fff;color:#000;margin:0;font-family:var(--font)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:3}
  .wrap{max-width:1080px;margin:0 auto;padding:16px}
  h1{margin:6px 0 10px 0;font-size:20px}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .muted{color:#4b5563;font-size:12px}
  button{background:#0b57d0;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  button.secondary{background:#eef2f6;color:#111}
  .ok{background:#1d9b52}

  /* Row editor */
  #cardsArea{display:flex;flex-direction:column;gap:10px;margin:12px 0}
  .cardRow{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:stretch}
  .cardRow textarea{min-height:74px;border:1px solid #cfd6de;border-radius:8px;padding:10px;width:100%}
  .del{background:#ef4444}

  /* Sheet layout */
  @page{size: 11in 8.5in; margin: var(--margin)}
  /* FIX 1: remove forced page breaks; rely on natural pagination */
  .print{width:var(--page-w);height:var(--page-h);position:relative;background:#fff;color:#000;
         page-break-after:auto; break-after:auto;}
  .sheet{position:absolute;inset:0;display:grid;grid-template-columns:repeat(2,var(--card-w));grid-template-rows:repeat(2,var(--card-h));justify-content:center;align-content:center}
  .card{position:relative;width:var(--card-w);height:var(--card-h);background:#fff;overflow:hidden}
  .card-inner{position:absolute;inset:var(--safe);display:flex;align-items:center;justify-content:center;text-align:center;font-size:14pt;line-height:1.25}
  .cut{position:absolute;inset:0.02in;border:0.3pt solid rgba(0,0,0,.35)}
  .card:before{content:"";position:absolute;left:0;right:0;top:0;bottom:0;background:
    linear-gradient(#000,#000) left -0.12in top 0/ var(--crop) 0.4pt no-repeat,
    linear-gradient(#000,#000) left 0 top -0.12in/ 0.4pt var(--crop) no-repeat,
    linear-gradient(#000,#000) right -0.12in top 0/ var(--crop) 0.4pt no-repeat,
    linear-gradient(#000,#000) right 0 top -0.12in/ 0.4pt var(--crop) no-repeat,
    linear-gradient(#000,#000) left -0.12in bottom 0/ var(--crop) 0.4pt no-repeat,
    linear-gradient(#000,#000) left 0 bottom -0.12in/ 0.4pt var(--crop) no-repeat,
    linear-gradient(#000,#000) right -0.12in bottom 0/ var(--crop) 0.4pt no-repeat,
    linear-gradient(#000,#000) right 0 bottom -0.12in/ 0.4pt var(--crop) no-repeat}
  .page-label{margin:12px 0 4px 0;font-size:13px;color:#334155}

  /* FIX 1b: ensure wrapper padding doesn't push sheets onto extra pages in print */
  @media print{
    header,.wrap.instructions,.page-label{display:none!important}
    #pages.wrap{padding:0!important;margin:0!important}
    .print{break-after:auto!important; page-break-after:auto!important}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Flashcards — Front | Back Row Editor → Arrange & Print</h1>

    <div class="controls">
      <button id="addCard" class="ok">+ Add Card</button>
      <label>Duplex flip:
        <select id="flip">
          <option value="long">Flip on LONG edge (recommended)</option>
          <option value="short">Flip on SHORT edge</option>
        </select>
      </label>
      <button id="btnArrange" class="ok">Arrange For Print</button>
      <button id="btnPDF" class="secondary">Build Both (PDF)</button>
      <button id="btnPrint">Print</button>
    </div>

    <div id="cardsArea"></div>
    <div class="muted">Each row is one card. Left = FRONT, Right = BACK. Use <strong>Arrange For Print</strong> before printing. Print with <strong>Scale 100%</strong> and <strong>Two-sided: Flip on long edge</strong>.</div>
  </div>
</header>

<div id="pages" class="wrap"></div>

<script>
(function(){
  var cardsArea = document.getElementById('cardsArea');
  var pages   = document.getElementById('pages');
  var flipEl  = document.getElementById('flip');
  var CARDS_PER_SHEET = 4;
  var CARDS = [];

  // FIX 2: conservative per-card limits to avoid overflow pushing layout
  var MAX_CHARS = 240;   // ~safe at 14pt, 1.25 line-height, 5.25" x 4" inner box
  var MAX_WORDS = 40;    // backstop if very short words inflate char count

  function clampText(s){
    s = (s||'').trim();
    if(!s) return '';
    var words = s.split(/\s+/);
    if(words.length > MAX_WORDS) words = words.slice(0, MAX_WORDS);
    var clipped = words.join(' ');
    if(clipped.length > MAX_CHARS) clipped = clipped.slice(0, MAX_CHARS).replace(/\s+\S*$/,'');
    if(clipped.length < s.length) clipped += '…';
    return clipped;
  }

  function addRow(front, back){
    var row = document.createElement('div');
    row.className = 'cardRow';
    row.innerHTML = '<textarea class="front" placeholder="front"></textarea>'+
                    '<textarea class="back"  placeholder="back"></textarea>'+
                    '<button class="del">✕</button>';
    cardsArea.appendChild(row);
    if(front) row.querySelector('.front').value = front;
    if(back)  row.querySelector('.back').value  = back;
    row.querySelector('.del').addEventListener('click', function(){ row.remove(); });
  }

  function readRows(){
    CARDS = [];
    var rows = cardsArea.querySelectorAll('.cardRow');
    rows.forEach(function(r){
      var f = clampText(r.querySelector('.front').value);
      var b = clampText(r.querySelector('.back').value);
      if(f || b) CARDS.push({front: f || b, back: b || f});
    });
  }

  function esc(s){ return s.replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];}); }
  function cardHTML(text){ return '<div class="card"><div class="cut"></div><div class="card-inner">'+esc(text).replace(/\n/g,'<br>')+'</div></div>'; }
  function sheetHTML(cards){ return '<div class="print"><div class="sheet">'+cards.join('')+'</div></div>'; }
  function chunk(arr,n){ var out=[]; for(var i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n)); return out; }

  function clearPages(){ pages.innerHTML = ''; }

  function renderFronts(){
    var groups = chunk(CARDS.map(function(c){return c.front;}), CARDS_PER_SHEET);
    groups.forEach(function(g){ while(g.length<CARDS_PER_SHEET) g.push(''); pages.insertAdjacentHTML('beforeend', '<div class="page-label">FRONTS</div>'+sheetHTML(g.map(cardHTML))); });
  }
  function renderBacks(){
    var groups = chunk(CARDS.map(function(c){return c.back;}), CARDS_PER_SHEET);
    var flip = flipEl.value; // landscape sheet
    groups.forEach(function(g){
      while(g.length<CARDS_PER_SHEET) g.push('');
      // Landscape: long-edge → mirror TOP/BOTTOM; short-edge → mirror LEFT/RIGHT
      var order = (flip==='long') ? [g[2],g[3],g[0],g[1]] : [g[1],g[0],g[3],g[2]];
      pages.insertAdjacentHTML('beforeend', '<div class="page-label">BACKS</div>'+sheetHTML(order.map(cardHTML)));
    });
  }

  function arrange(){
    readRows();
    clearPages();
    renderFronts();
    renderBacks();
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  }

  // Buttons
  document.getElementById('addCard').addEventListener('click', function(){ addRow('',''); });
  document.getElementById('btnArrange').addEventListener('click', arrange);
  document.getElementById('btnPDF').addEventListener('click', function(){ arrange(); requestAnimationFrame(function(){ window.print(); }); });
  document.getElementById('btnPrint').addEventListener('click', function(){ if(!pages.querySelector('.print')) arrange(); requestAnimationFrame(function(){ window.print(); }); });

  // Seed two example rows so page shows structure
  addRow('ATFL','Resists inversion + PF');
  addRow('Subtalar','Pronation / supination');
})();
</script>
</body>
</html>
